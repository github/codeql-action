name: "Go: Reconciled tracing with custom build steps"
description: "Checks that reconciled Go tracing traces the build when using custom build steps"
env:
  # Enable reconciled Go tracing beta functionality
  CODEQL_ACTION_RECONCILE_GO_EXTRACTION: "true"
steps:
  - uses: actions/setup-go@v3
    with:
      go-version: "^1.13.1"
  - uses: ./../action/init
    with:
      languages: go
      tools: ${{ steps.prepare-test.outputs.tools-url }}
    env:
      TEST_MODE: true
  - name: Build code
    shell: bash
    run: go build main.go
  - uses: ./../action/analyze
    env:
      TEST_MODE: true
  - shell: bash
    run: |
      if [[ -v CODEQL_ACTION_DID_AUTOBUILD_GOLANG ]]; then
        echo "Expected the Go autobuilder not to be run, but the" \
          "CODEQL_ACTION_DID_AUTOBUILD_GOLANG environment variable was set."
        exit 1
      fi
      cd "$RUNNER_TEMP/codeql_databases"
      if [[ ! -d go ]]; then
        echo "Did not find a Go database"
        exit 1
      fi
